<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <style>
        body{
            background-color: gray;
        }
    </style>
    <div id="contanir"></div>
    <div id="oneCard">+1</div>
    <div id="historyCard"></div>
    <script>
        const arrOfCard = [];
        const socket =new WebSocket('ws://localhost:3000');                                                                                                                                                                                                                    
        const contanir = document.getElementById('contanir');
        const oneCard = document.getElementById('oneCard');
        const historyCard = document.getElementById("historyCard");
        let yourOrder = 0;
        let lastcard = {
            number:-1,
            color:-1
        }
        let index = 0 ;
        socket.onopen = ()=> {}
        socket.onmessage = (event) =>{
            const data = JSON.parse(event.data);
            if (data.type === 'order')
            {
                yourOrder = data.order;
            }
            if (data.type === 'cards')
            {
                data.cards.forEach(sigelCard => {
                    const newCardDiv = document.createElement('div');
                    newCardDiv.textContent = sigelCard.n;
                    newCardDiv.style.color = sigelCard.c;
                    arrOfCard.push({
                        number:sigelCard.n,
                        color:sigelCard.c,
                        DivOfCard: newCardDiv
                    })
                    newCardDiv.dataset.index = index;
                    index ++; 
                    newCardDiv.classList.add('card');
                    contanir.appendChild(newCardDiv);
                    
                });
            }
            if (data.type === 'lastcard')
            {
                lastcard.color =data.color;
                lastcard.number = data.number;
                const lastCardDiv = document.createElement("div");
                lastCardDiv.textContent = lastcard.number;
                lastCardDiv.style.color = lastcard.color;
                lastCardDiv.classList.add('lastcard');
                historyCard.appendChild(lastCardDiv);
            }
            if (data.type === 'start')
            {   
                oneCardFunction(true)
                arrOfCard.forEach(elemenOFarray => {
                    if (elemenOFarray.number === lastcard.number || elemenOFarray.color === lastcard.color ||lastcard.number === -1 ||elemenOFarray.color === 'black')
                    {
                        console.log(elemenOFarray.number + ' === '+lastcard.number + " || " + elemenOFarray.color + " === " + lastcard.color )
                        if (elemenOFarray.color === 'black')
                        {
                            creatColor(elemenOFarray , 'play a card');
                        }
                        else {
                            play(elemenOFarray , 'play a card')
                        }
                    }
                })
            }
            if (data.type === 'ready or not')
            {
                cardPlus(false);
            }
            if (data.type === '+2')
            {
                cardPlus(true);
            }
        }
        function clear() {
                arrOfCard.forEach(div => {
                    div.DivOfCard.onclick = null;
                    div.DivOfCard.style.border = 'none';
                })
            oneCard.onclick = null;
            oneCard.style.border = 'none';
        }
        function creatColor (opjectElement , type){
                const divOfcolorCard  = opjectElement.DivOfCard;
                divOfcolorCard.style.border = '1px solid black';
                divOfcolorCard.onclick = () => {
                    clear();
                let colors = ['red' , 'yellow' , 'green' , 'blue'];
                    colors.forEach(color => {
                        const new4ColorDiv = document.createElement('div');
                        new4ColorDiv.style.width = '50px';
                        new4ColorDiv.style.height = '50px';
                        new4ColorDiv.style.backgroundColor = color;
                        new4ColorDiv.classList.add('color')
                        divOfcolorCard.appendChild(new4ColorDiv);
                        new4ColorDiv.onclick = () => {
                            socket.send(JSON.stringify({
                            type:type,
                            order: yourOrder,
                            number: opjectElement.number,
                            color:color
                        }))
                        const clearColorDiv = divOfcolorCard.querySelectorAll('div');
                        clearColorDiv.forEach(x => {
                            x.style.display= 'none';
                        })
                        arrOfCard.splice(divOfcolorCard.dataset.index , 1);
                        restIndex();
                        divOfcolorCard.style.display = 'none';
                        
                        }
                    })
                }
        }
        function oneCardFunction(type){
             oneCard.style.border =  '1px solid black';
                oneCard.onclick = () => {
                    socket.send(JSON.stringify({
                        type:'help',
                        order:yourOrder,
                        state:type
                    }))
                    clear();
                }
        }
        function play(opjectElement , type){
            let singelCard = opjectElement.DivOfCard
            singelCard.style.border = '1px solid black';
            singelCard.onclick = () => {
                socket.send(JSON.stringify({
                    type:type,
                    order: yourOrder,
                    number: opjectElement.number,
                    color:opjectElement.color
                }))
                console.log(opjectElement.color)
                singelCard.style.display = 'none';
                arrOfCard.splice(singelCard.dataset.index , 1)
                restIndex();
                clear();
            }
        }
        function cardPlus(x){
            oneCardFunction(false);
                arrOfCard.forEach(opjectElement => {
                    if (opjectElement.number === '+4')
                    {
                        creatColor(opjectElement , 'yes');
                    }
                    else if (opjectElement.number === '+2' && (opjectElement.color === lastcard.color || x))
                    {
                        play(opjectElement , 'yes');
                    }
                })
        }
        function restIndex(){
            index = 0 ;
            arrOfCard.forEach(cardOpj => {
                cardOpj.DivOfCard.dataset.index = index;
                index++;
            })
        }
        /*
        خطوات راح نسويها
        نسوي الاري تمهيدا للنظام رمي الكروت
        نكمل المشروع بين اثنين تمهيدا للتركيز على الداتا بيس
        ثم نخطط وش نسوي
        */
       /*
        المشاكل
        اول مشكلةهي مشكلة انه بعد ما تحط زايد اربعة ما تقدر تكمل لعب طبيعي
        ثنين زايد اثنين ما يظهر له اللون 
       */
    </script>
</body>
</html>